{% extends "base.html" %}
{% load static %}

{% block title %}Gestión de Usuarios{% endblock %}

{% block content %}
<div class="admin-container" style="margin-top: 20px;">
    <div class="admin-header">
        <h1>
            <i class="bi bi-people-fill"></i> Gestión de Usuarios
        </h1>
    </div>

    {% if messages %}
        {% for message in messages %}
        <div class="alert-custom alert-{{ message.tags }}">
            <i class="bi bi-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}x-circle{% else %}info-circle{% endif %}"></i>
            <span>{{ message }}</span>
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    {% endif %}

    <div class="info-cards">
        <div class="info-card info">
            <i class="bi bi-person-circle"></i>
            <h5>Miembro</h5>
            <p><strong>Permisos:</strong></p>
            <ul style="text-align: left; font-size: 0.85rem; margin: 0.5rem 0 0 0; padding-left: 1.5rem;">
                <li>Ver artículos y noticias</li>
                <li>Dejar comentarios</li>
                <li>Editar sus propios comentarios</li>
            </ul>
        </div>
        <div class="info-card success">
            <i class="bi bi-pencil-square"></i>
            <h5>Colaborador</h5>
            <p><strong>Permisos:</strong></p>
            <ul style="text-align: left; font-size: 0.85rem; margin: 0.5rem 0 0 0; padding-left: 1.5rem;">
                <li>Todo lo de Miembro</li>
                <li>Crear artículos</li>
                <li>Editar sus propios artículos</li>
                <li>Eliminar sus propios artículos</li>
            </ul>
        </div>
        <div class="info-card warning">
            <i class="bi bi-shield-check"></i>
            <h5>Administrador</h5>
            <p><strong>Permisos:</strong></p>
            <ul style="text-align: left; font-size: 0.85rem; margin: 0.5rem 0 0 0; padding-left: 1.5rem;">
                <li>Todo lo de Colaborador</li>
                <li>Gestionar roles de usuarios</li>
                <li>Crear y editar categorías</li>
                <li>Eliminar categorías sin artículos</li>
            </ul>
        </div>
    </div>

    <!-- Buscador -->
    <div style="margin-bottom: 2rem;">
        <div style="display: flex; gap: 1rem; align-items: center; max-width: 600px;">
            <div style="flex: 1; position: relative;">
                <i class="bi bi-search" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-color); opacity: 0.5;"></i>
                <input 
                    type="text" 
                    id="searchInput"
                    placeholder="Buscar por usuario o email..." 
                    style="width: 100%; padding: 0.8rem 1rem 0.8rem 3rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-color); font-size: 1rem;"
                >
            </div>
            <button id="clearSearch" class="btn-admin btn-admin-outline" style="min-width: 120px; display: none;">
                <i class="bi bi-x-circle-fill"></i> Limpiar
            </button>
        </div>
    </div>

    <div id="searchResults" style="margin-bottom: 1rem; color: var(--text-color); display: none;">
        <i class="bi bi-info-circle"></i> Mostrando <strong id="resultCount">0</strong> resultado(s)
    </div>

    <div class="admin-table-container">
        <table class="admin-table">
            <thead>
                <tr>
                    <th style="width: 30%;">Usuario</th>
                    <th style="width: 35%;">Email</th>
                    <th style="width: 35%;" class="text-center">Rol</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                {% for usuario in usuarios %}
                <tr class="user-row" data-username="{{ usuario.username|lower }}" data-email="{{ usuario.email|lower|default:'' }}">
                    <td class="username-cell">
                        {{ usuario.username }}
                    </td>
                    <td>{{ usuario.email|default:"-" }}</td>
                    <td class="text-center">
                        {% if usuario.is_superuser %}
                        <span class="badge-custom badge-danger locked-role">Superusuario</span>
                        {% else %}
                            {% if usuario.perfil.rol == 'administrador' and not es_superusuario %}
                            <span class="badge-custom badge-warning locked-role" title="Solo el superusuario puede modificar administradores">
                                Administrador <i class="bi bi-lock-fill" style="font-size: 0.8rem;"></i>
                            </span>
                            {% else %}
                            <form method="post" class="role-form" onsubmit="this.querySelector('.btn-save-role').classList.add('saving');">
                                {% csrf_token %}
                                <input type="hidden" name="usuario_id" value="{{ usuario.id }}">
                                <div class="role-selector-container">
                                    <select name="rol" class="role-selector" onchange="this.form.querySelector('.btn-save-role').style.display='inline-flex';">
                                        {% for value, display in roles_disponibles %}
                                        <option value="{{ value }}" {% if usuario.perfil.rol == value %}selected{% endif %}>
                                            {{ display }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <button type="submit" class="btn-save-role" style="display: none;" title="Guardar cambios">
                                        <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor" style="flex-shrink: 0;">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                        </svg>
                                    </button>
                                </div>
                            </form>
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3">
                        <div class="empty-state">
                            <i class="bi bi-person-x"></i>
                            <p>No se encontraron usuarios{% if busqueda %} que coincidan con "{{ busqueda }}"{% endif %}</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div style="margin-top: 2rem;">
        <a href="{% url 'index' %}" class="btn-admin btn-admin-outline">
            <i class="bi bi-arrow-left-circle"></i> Volver al inicio
        </a>
    </div>
</div>

<script>
// Filtrado en tiempo real de usuarios
const searchInput = document.getElementById('searchInput');
const clearButton = document.getElementById('clearSearch');
const searchResults = document.getElementById('searchResults');
const resultCount = document.getElementById('resultCount');
const userRows = document.querySelectorAll('.user-row');

if (searchInput) {
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        let visibleCount = 0;
        
        userRows.forEach(row => {
            const username = row.dataset.username;
            const email = row.dataset.email;
            
            // Buscar en username o email
            if (username.includes(searchTerm) || email.includes(searchTerm)) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Mostrar/ocultar elementos según si hay búsqueda
        if (searchTerm) {
            clearButton.style.display = '';
            searchResults.style.display = '';
            resultCount.textContent = visibleCount;
        } else {
            clearButton.style.display = 'none';
            searchResults.style.display = 'none';
        }
    });
    
    // Botón limpiar
    clearButton.addEventListener('click', function() {
        searchInput.value = '';
        searchInput.dispatchEvent(new Event('input'));
        searchInput.focus();
    });
}
</script>
{% endblock %}
